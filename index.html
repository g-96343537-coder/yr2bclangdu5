<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æˆ‘çˆ±æˆ‘çš„å®¶ - æœ—è¯»æ‰“å¡</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  body {
    font-family: "æ¥·ä½“", "KaiTi", sans-serif;
    background: url('https://png.pngtree.com/background/20230412/original/pngtree-cartoon-house-building-house-trees-picture-image_2395321.jpg') center/cover no-repeat fixed;
    padding: 20px;
    font-size: 32px;
    line-height: 1.9;
    color: #000;
    min-height: 100vh;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* é€šç”¨å®¹å™¨æ ·å¼ */
  .container-box {
    background: rgba(255,255,255,0.9); /*ç¨å¾®åŠ æ·±ä¸€ç‚¹ä¸é€æ˜åº¦ä»¥ä¾¿é˜…è¯»*/
    padding: 30px;
    border-radius: 20px;
    width: 100%;
    max-width: 900px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    display: none; /* é»˜è®¤éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
    animation: fadeIn 0.5s ease;
  }

  /* å½“å‰æ¿€æ´»çš„é¡µé¢æ˜¾ç¤º */
  .container-box.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  h1 {
    text-align: center;
    margin-bottom: 20px;
    color: #d63384;
  }

  /* ç™»å½•é¡µæ ·å¼ */
  .form-group {
    margin-bottom: 25px;
    text-align: center;
  }
  
  label {
    display: block;
    font-size: 24px;
    margin-bottom: 10px;
    font-weight: bold;
  }

  select, input {
    font-family: "æ¥·ä½“", "KaiTi", sans-serif;
    font-size: 24px;
    padding: 10px;
    width: 80%;
    border: 2px solid #ff9bb6;
    border-radius: 10px;
    outline: none;
    text-align: center;
  }

  .user-info-bar {
    background: #fff0f5;
    padding: 10px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    font-size: 20px;
    color: #555;
    display: flex;
    justify-content: space-between;
    border: 1px solid #ff9bb6;
  }

  .sentence {
    padding: 14px 20px;
    margin: 14px 0;
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    cursor: pointer;
    opacity: 0;
    transform: scale(0.9);
    transition: transform 0.45s ease, opacity 0.45s ease, background 0.3s;
  }
  .sentence.show {
    opacity: 1;
    transform: scale(1);
  }
  .sentence.active {
    background: #ffe6ef;
    transform: scale(1.05);
    border-left: 5px solid #ff9bb6;
  }

  #controls {
    margin-top: 30px;
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
  }

  button {
    font-family: "æ¥·ä½“", "KaiTi", sans-serif;
    font-size: 26px;
    padding: 12px 24px;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    background: #ff9bb6;
    color: #fff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: all 0.2s;
  }
  button:hover { background: #ff82a3; transform: scale(1.05);}
  button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
  
  .btn-green { background: #4caf50; }
  .btn-green:hover { background: #45a049; }

  #imageBox {
    text-align: center;
    margin: 25px 0;
  }
  #imageBox img {
    max-width: 80%;
    border-radius: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  #pagination {
    margin-top: 30px;
    display: flex;
    justify-content: space-between;
  }

  /* è°·æ­ŒæŒ‰é’®å±…ä¸­ */
  .google-btn-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 20px;
  }

  /* æˆåŠŸé¡µé¢æ ·å¼ */
  .success-content {
    text-align: center;
    padding: 40px;
  }
  .big-icon { font-size: 80px; margin-bottom: 20px; display: block;}
</style>
</head>
<body>

<div id="loginView" class="container-box active">
  <h1>æ¬¢è¿æ¥åˆ°å¿«ä¹é˜…è¯»</h1>
  
  <div class="form-group">
    <label>è¯·é€‰æ‹©æˆ–è¾“å…¥ç­çº§ï¼š</label>
    <select id="classInput">
      <option value="" disabled selected>è¯·ç‚¹å‡»é€‰æ‹©...</option>
      <option value="1å¹´çº§">1å¹´çº§</option>
      <option value="2å¹´çº§">2å¹´çº§</option>
      <option value="3å¹´çº§">3å¹´çº§</option>
      <option value="4å¹´çº§">4å¹´çº§</option>
      <option value="5å¹´çº§">5å¹´çº§</option>
      <option value="6å¹´çº§">6å¹´çº§</option>
    </select>
  </div>

  <div class="form-group">
    <label>è¯·ä½¿ç”¨ Google è´¦å·ç™»å½•ï¼š</label>
    <div class="google-btn-wrapper">
      <div id="g_id_onload"
           data-client_id="1006856013626-uk3eq5tchv9t65gqosb0k6rst7hi1eeb.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
    </div>
  </div>
  
  <p style="text-align:center; font-size:16px; color:#666;">ç™»å½•æˆåŠŸåå°†è‡ªåŠ¨è·³è½¬</p>
</div>

<div id="readView" class="container-box">
  <div class="user-info-bar">
    <span id="displayClass">ç­çº§: -</span>
    <span id="displayName">å§“å: -</span>
  </div>

  <h1>æˆ‘çˆ±æˆ‘çš„å®¶</h1>
  
  <div id="imageBox">
    </div>
  
  <div id="content"></div>
  
  <div id="controls">
    <button onclick="playAuto()">è‡ªåŠ¨æ’­æ”¾</button>
    <button onclick="stopAuto()" style="background:#ffb7b2">åœæ­¢æ’­æ”¾</button>
  </div>
  
  <div id="pagination">
    <button onclick="prevPage()" id="prevBtn">ä¸Šä¸€é¡µ</button>
    <button onclick="nextPage()" id="nextBtn">ä¸‹ä¸€é¡µ</button>
  </div>
</div>

<div id="successView" class="container-box">
  <div class="success-content">
    <span class="big-icon">ğŸ‰</span>
    <h1 style="color:#4caf50">å¤ªæ£’äº†ï¼</h1>
    <p>ä½ è¯»å¾—çœŸå¥½ï¼</p>
    <p>çœŸæ˜¯ä¸ªçˆ±å­¦ä¹ çš„å¥½å­©å­ï¼</p>
    <p style="font-size:18px; color:#888; margin-top:20px;">(æˆç»©å·²æäº¤ç»™è€å¸ˆ)</p>
    <br>
    <button onclick="location.reload()">å†è¯»ä¸€æ¬¡</button>
  </div>
</div>

<script>
// ================= é…ç½®åŒºåŸŸ =================
// ğŸ”´ è¯·å°†ä¸‹æ–¹çš„ URL æ›¿æ¢ä¸ºæ‚¨éƒ¨ç½²çš„ Google Apps Script (GAS) Web App URL
const GAS_URL = "https://script.google.com/macros/s/AKfycby3GXc4tyA7tGcgbRTZ1tSv68GcrXWuRlwZL_q3JC5OVxFo6WxRp0X7btimmbUro5SOqg/exec";

const textArray = [
  "å®¶æ˜¯ä»€ä¹ˆï¼Ÿ",
  "å®¶ï¼Œæ˜¯ä¸€ç›ç¯ã€ä¸€ä¸ªæˆ¿é—´ã€ä¸€å¼ èˆ’é€‚çš„åºŠã€‚",
  "æœ‰äº†ç¯ï¼Œä¸å†å®³æ€•å¤œæ™šæ²¡æœ‰æ˜Ÿæ˜Ÿå’Œæœˆäº®ã€‚",
  "æœ‰äº†æˆ¿é—´ï¼Œä¸å†æ‹…å¿ƒé£å¹é›¨æ‰“ã€‚",
  "æœ‰äº†åºŠï¼Œç´¯äº†ï¼Œå›°äº†ï¼Œå¯ä»¥ç¡ä¸Šç”œç”œçš„è§‰ã€‚",
  "å®¶æ˜¯ä»€ä¹ˆï¼Ÿ",
  "å®¶ï¼Œæ˜¯ä¸€è½®å¤ªé˜³ã€‚",
  "çˆ¸çˆ¸å¦ˆå¦ˆæ¬¢ä¹çš„ç¬‘å®¹ï¼Œåˆæˆæ¸©æš–çš„é˜³å…‰ã€‚"
];

// ================= çŠ¶æ€å˜é‡ =================
let currentUser = null;
let currentClass = "";
let page = 0;
const pageSize = 4;
let autoIndex = 0;
let autoPlayTimer = null;

// ================= ç™»å½•é€»è¾‘ =================
function handleCredentialResponse(response) {
  const classVal = document.getElementById("classInput").value;
  if (!classVal) {
    alert("è¯·å…ˆé€‰æ‹©ç­çº§å“¦ï¼");
    return;
  }
  
  // è§£ç  Google Token
  const responsePayload = decodeJwtResponse(response.credential);
  currentUser = {
    name: responsePayload.name,
    email: responsePayload.email,
    picture: responsePayload.picture
  };
  currentClass = classVal;

  // åˆ‡æ¢ç•Œé¢
  document.getElementById("loginView").classList.remove("active");
  document.getElementById("readView").classList.add("active");

  // æ˜¾ç¤ºä¿¡æ¯
  document.getElementById("displayClass").textContent = "ç­çº§: " + currentClass;
  document.getElementById("displayName").textContent = "å§“å: " + currentUser.name;

  // åˆå§‹åŒ–é˜…è¯»
  renderPage();
}

function decodeJwtResponse(token) {
  var base64Url = token.split('.')[1];
  var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
  return JSON.parse(jsonPayload);
}

// ================= é˜…è¯»é€»è¾‘ =================
function renderPage() {
  const content = document.getElementById("content");
  content.innerHTML = "";
  autoIndex = 0;

  const slice = textArray.slice(page * pageSize, (page + 1) * pageSize);
  slice.forEach((sentence, idx) => {
    const div = document.createElement("div");
    div.className = "sentence";
    div.textContent = sentence;
    div.onclick = () => readSentence(div, sentence);
    content.appendChild(div);

    // å»¶è¿Ÿæ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
      div.classList.add('show');
    }, 120 * idx);
  });

  updatePaginationButtons();
}

function updatePaginationButtons() {
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  // ä¸Šä¸€é¡µé€»è¾‘
  prevBtn.disabled = (page === 0);

  // ä¸‹ä¸€é¡µé€»è¾‘ï¼šå¦‚æœæ˜¯æœ€åä¸€é¡µï¼ŒæŒ‰é’®å˜æˆâ€œå®Œæˆæ‰“å¡â€
  if ((page + 1) * pageSize >= textArray.length) {
    nextBtn.textContent = "å®Œæˆæ‰“å¡ âœ…";
    nextBtn.classList.add("btn-green");
    nextBtn.onclick = finishStudy;
  } else {
    nextBtn.textContent = "ä¸‹ä¸€é¡µ";
    nextBtn.classList.remove("btn-green");
    nextBtn.onclick = nextPage;
  }
}

function readSentence(div, sentence) {
  document.querySelectorAll('.sentence').forEach(s => s.classList.remove('active'));
  if(div) div.classList.add('active');
  
  window.speechSynthesis.cancel(); // åœæ­¢ä¹‹å‰çš„
  const utter = new SpeechSynthesisUtterance(sentence);
  utter.lang = "zh-CN";
  utter.rate = 0.9; // ç¨å¾®æ…¢ä¸€ç‚¹é€‚åˆé˜…è¯»
  window.speechSynthesis.speak(utter);
}

function playAuto() {
  stopAuto();
  // å…ˆè¯»å½“å‰é¡µçš„ç¬¬ä¸€å¥
  const items = document.querySelectorAll('.sentence');
  if(items.length === 0) return;

  autoIndex = 0;
  
  // å®šä¹‰é€’å½’æ’­æ”¾å‡½æ•°
  function playNext() {
    if (autoIndex >= items.length) {
      // å½“å‰é¡µè¯»å®Œäº†ï¼Œåœæ­¢
      stopAuto();
      return; 
    }
    
    const div = items[autoIndex];
    const text = div.textContent;
    
    // é«˜äº®
    document.querySelectorAll('.sentence').forEach(s => s.classList.remove('active'));
    div.classList.add('active');

    // æ’­æ”¾
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "zh-CN";
    utter.rate = 0.9;
    
    // è¯»å®Œè¿™ä¸€å¥åï¼Œè¯»ä¸‹ä¸€å¥
    utter.onend = function() {
      autoIndex++;
      // åœé¡¿ä¸€å°ä¼šå†è¯»ä¸‹ä¸€å¥
      autoPlayTimer = setTimeout(playNext, 800);
    };
    
    window.speechSynthesis.speak(utter);
  }

  playNext();
}

function stopAuto() {
  window.speechSynthesis.cancel();
  clearTimeout(autoPlayTimer);
  document.querySelectorAll('.sentence').forEach(s => s.classList.remove('active'));
}

function nextPage() {
  stopAuto();
  if ((page + 1) * pageSize < textArray.length) {
    page++;
    renderPage();
  }
}

function prevPage() {
  stopAuto();
  if (page > 0) {
    page--;
    renderPage();
  }
}

// ================= å®Œæˆä¸æäº¤é€»è¾‘ =================
function finishStudy() {
  stopAuto();
  
  // 1. æäº¤æ•°æ®åˆ° GAS
  submitDataToGAS();

  // 2. æ˜¾ç¤ºæˆåŠŸé¡µé¢
  document.getElementById("readView").classList.remove("active");
  document.getElementById("successView").classList.add("active");
}

function submitDataToGAS() {
  if (!currentUser) return;

  const formData = new URLSearchParams();
  formData.append('name', currentUser.name);
  formData.append('email', currentUser.email);
  formData.append('class', currentClass);
  formData.append('score', "å®Œæˆé˜…è¯»"); // è¿™é‡Œå¯ä»¥è®°å½•çŠ¶æ€
  formData.append('total', textArray.length);

  // å‘é€è¯·æ±‚ (no-cors æ¨¡å¼ï¼Œåªç®¡å‘é€ä¸ç®¡è¿”å›ç»“æœï¼Œé¿å…è·¨åŸŸæŠ¥é”™)
  fetch(GAS_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: formData
  }).then(() => {
    console.log("æ•°æ®å·²å‘é€");
  }).catch(err => {
    console.error("å‘é€å¤±è´¥", err);
  });
}
</script>

</body>
</html>